<!DOCTYPE html>
<html>
<head>
    <title>Quickstart for MSAL JS</title>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/0.2.3/js/msal.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" class="pre"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js" class="pre"></script>
    <style>
        table, td, th {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <h4 id="WelcomeMessage"></h4>
    <button id="SignIn" onclick="signIn()">Sign In</button><br /><br />
    <table id="graphData"></table>

    <script>
        var applicationConfig = {
            clientID: '0813e1d1-ad72-46a9-8665-399bba48c201', //This is your client ID
            graphScopes: ["user.read"],
            graphEndpoint: "https://graph.microsoft.com/v1.0/me"
        };

        //pass null for default authority (https://login.microsoftonline.com/common) and tokenReceivedCallback if using popup api's'
        var myMSALObj = new Msal.UserAgentApplication(applicationConfig.clientID, null, userSignedIn);

        function signIn() {
            myMSALObj.loginRedirect();
        }

        function signOut() {
            myMSALObj.logout();
        }

        function userSignedIn(errorDesc, token, error, tokenType) {
            //In redirect mode, use this inside callback to access an instance of userAgentApplication
            var self = this;
            if (token) {
                if (tokenType === "id_token") {
                    showWelcomeMessage(self);
                }
            }
            else if (errorDesc || error) {
                console.log(error + ' : ' + errorDesc);
            }
        }

        function acquireTokenAndCallMSGraph(myMSALObj) {
            //Call acquireTokenSilent (iframe) to obtain a token for Microsoft Graph
            myMSALObj.acquireTokenSilent(applicationConfig.graphScopes).then(function (accessToken) {
                callMSGraph(applicationConfig.graphEndpoint, accessToken, graphAPICallback);
            }, function (error) {
                //Call acquireTokenRedirect in case of acquireToken Failure
                if (error.indexOf("consent_required") !== -1 || error.indexOf("interaction_required") !== -1) {
                    myMSALObj.acquireTokenRedirect(applicationConfig.graphScopes);
                }
            });
        }

        function callMSGraph(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xmlHttp.send();
        }

        function graphAPICallback(data) {
            //Display user data on DOM
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML += " to Microsoft Graph API!!";
            $.each(data, function (key, value) {
                var tr = $('<tr></tr>');
                $('<td>' + '<i>' + key + '</i>' + '</td>').appendTo(tr);
                $('<td>' + value + '</td>').appendTo(tr);
                tr.appendTo('#graphData');
            });
        }

        function showWelcomeMessage(myMSALObj) {
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML = 'Welcome ' + myMSALObj.getUser().name;
            var loginbutton = document.getElementById('SignIn');
            loginbutton.innerHTML = 'Sign Out';
            loginbutton.setAttribute('onclick', 'signOut();');
        }

        if (myMSALObj && myMSALObj.getUser() && !myMSALObj.loginInProgress() && !myMSALObj.isCallback(window.location.hash)) {// avoid duplicate code execution on page load in case of iframe and popup window.
            showWelcomeMessage(myMSALObj);
            acquireTokenAndCallMSGraph(myMSALObj);
        }
    </script>
</body>
</html>
