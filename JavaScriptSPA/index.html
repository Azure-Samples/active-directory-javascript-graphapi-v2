<!DOCTYPE html>
<html>
<head>
    <title>Quickstart for MSAL JS</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/0.2.3/js/msal.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<body>
    <h2>Welcome to MSAL.js Quickstart</h2><br/>
    <h4 id="WelcomeMessage"></h4>
    <button id="SignIn" onclick="signIn()">Sign In</button><br/><br/>
	<pre id="json"></pre>

    <script>
		// Browser check variables
		var ua = window.navigator.userAgent;
		var msie = ua.indexOf('MSIE ');
		var msie11 = ua.indexOf('Trident/');
		var msedge = ua.indexOf('Edge/');
		var isIE = msie > 0 || msie11 > 0;
		var isEdge = msedge > 0;
	
        var applicationConfig = {
            clientID: "0813e1d1-ad72-46a9-8665-399bba48c201", //This is your client ID
            graphScopes: ["user.read"],
            graphEndpoint: "https://graph.microsoft.com/v1.0/me"
        };

        //Pass null for default authority (https://login.microsoftonline.com/common) and tokenReceivedCallback if using popup apis
        var myMSALObj = new Msal.UserAgentApplication(applicationConfig.clientID, null, null, {storeAuthStateInCookie:true});
				
        function signIn() {
			myMSALObj.loginPopup(applicationConfig.graphScopes).then(function (idToken) {
                //Login Success
                showWelcomeMessage();
                acquireTokenAndCallMSGraph();
            }, function (error) {
                console.log(error);
            });
        }
		
        function signOut() {
            myMSALObj.logout();
        }

        function acquireTokenAndCallMSGraph() {
			//Call acquireTokenSilent (iframe) to obtain a token for Microsoft Graph
            myMSALObj.acquireTokenSilent(applicationConfig.graphScopes).then(function (accessToken) {
                callMSGraph(applicationConfig.graphEndpoint, accessToken, graphAPICallback);
            }, function (error) {
				if (isIE) {
					alert("IE");
					// NOTE: only for IE browsers
					// Call acquireTokenRedirect in case of acquireToken Failure
					if (error.indexOf("consent_required") !== -1 || error.indexOf("interaction_required") !== -1) {
						myMSALObj.acquireTokenRedirect(applicationConfig.graphScopes);
					}
				}
				// Uncomment this if you are testing in Edge InPrivate, or delete
				/**
				else if(msedge > 0) {
					// NOTE: only for Edge InPrivate browsers
					// Call acquireTokenRedirect in case of acquireToken Failure
					if (error.indexOf("consent_required") !== -1 || error.indexOf("interaction_required") !== -1) {
						myMSALObj.acquireTokenRedirect(applicationConfig.graphScopes);
					}
				}
				**/
				else {
					// Call acquireTokenPopup (popup window) in case of acquireToken Failure
					if (error.indexOf("consent_required") !== -1 || error.indexOf("interaction_required") !== -1) {
						myMSALObj.acquireTokenPopup(applicationConfig.graphScopes).then(function (accessToken) {
							callMSGraph(applicationConfig.graphEndpoint, accessToken, graphAPICallback);
						}, function (error) {
						});
					}
				}
            });
        }

        function callMSGraph(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xmlHttp.send();
        }

        function graphAPICallback(data) {
            //Display user data on DOM
            var divWelcome = document.getElementById('WelcomeMessage');
            document.getElementById("json").innerHTML = JSON.stringify(data, null, 2);
        }

        function showWelcomeMessage() {
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML += 'Welcome ' + myMSALObj.getUser().name + " to Microsoft Graph API!!";
            var loginbutton = document.getElementById('SignIn');
            loginbutton.innerHTML = 'Sign Out';
            loginbutton.setAttribute('onclick', 'signOut();');
        }
		
		// Remove this code if IE is not used
		if(isIE) {
			document.getElementById("SignIn").onclick = function() {
				myMSALObj.loginRedirect(applicationConfig.graphScopes);
			};
		} 
		// Uncomment this if you are testing in Edge InPrivate, or delete
		/**
		else if(isEdge) {
			document.getElementById("SignIn").onclick = function () { 
				myMSALObj.loginRedirect(applicationConfig.graphScopes);
			};
		}
		**/

        if (myMSALObj.getUser() && !myMSALObj.isCallback(window.location.hash)) {// avoid duplicate code execution on page load in case of iframe and popup window.
			showWelcomeMessage();
            acquireTokenAndCallMSGraph();
        }
				
    </script>
</body>
</html>
