<html>
<head>
    <title>Quickstart for Microsoft authentication library for JS</title>
    <style>
        .hidden {
            visibility: hidden;
        }

        .visible {
            visibility: visible;
        }
    </style>
</head>
<body>
<!-- bluebird only needed if this page needs to run on Internet Explorer -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js" class="pre"></script>
<script src="https://secure.aadcdn.microsoftonline-p.com/lib/0.2.2/js/msal.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" class="pre"></script>

<div>
    <div id="label">Sign-in with Microsoft</div>
    <br>
    <br>
    <button id="auth" onclick="loginRedirect();">Login</button>
    <br>
    <br>
    <button id="callGraph" class="hidden" onclick="callGraph();">Call Microsoft Graph</button>
</div>

<pre class="response"></pre>

<script class="pre">
//=========================================================================== Authentication code =======================================================================================
    var applicationConfig = {
        clientID: '0813e1d1-ad72-46a9-8665-399bba48c201',
        graphScopes: ["user.read"],
        graphEndpoint: "https://graph.microsoft.com/v1.0/me"
    };

    //MSAL Initialization
    var userAgentApplication = new Msal.UserAgentApplication(applicationConfig.clientID, null, authCallback, {
        cacheLocation: 'localStorage',
        logger: logger,
        storeAuthStateInCookie: true
    });// cacheLocation defaults to sessionStorage if not set in the constructor

    //Optional Logging
    var logger = new Msal.Logger(loggerCallback, {level: Msal.LogLevel.Verbose, correlationId: '12345'});

    function loggerCallback(logLevel, message, piiEnabled) {
        console.log(message);
    }

    // use the getUser() API to check if user session already exists
    if (userAgentApplication.getUser()) {
        updateUI();
    }
    else
    {
        //do something
    }

    //invoke login API
    function loginRedirect() {
        //passing scopes for consent. No access token would be acquire for these scopes at this time.
        userAgentApplication.loginRedirect(applicationConfig.graphScopes);
    }

    //invoke logout API
    function logout() {
        // Removes all sessions, need to call AAD endpoint to do full logout
        userAgentApplication.logout();
    }

    //token receive callback
    function authCallback(errorDesc, token, error, tokenType) {
        if (token) {
            if (tokenType === "id_token") {
                console.log("id token " + token);
                updateUI();
            }
            else  if (tokenType === "access_token") {
                console.log("access token " + token);
                httpGetAsync(applicationConfig.graphEndpoint, token, httpGetCallback);
            }
        }
        else if (errorDesc || error) {
            console.log(error + ' : ' + errorDesc);
        }
    }


    //Call MS Graph API
    function callGraph() {
        console.log(" calling MS Graph...");
        userAgentApplication.acquireTokenSilent(applicationConfig.graphScopes).then(function (accessToken) {
            console.log("access token " + accessToken);
            httpGetAsync(applicationConfig.graphEndpoint, accessToken, httpGetCallback);
        }, function (error) {
            //if silent call fails call the interactive.
            console.log(error);
            userAgentApplication.acquireTokenRedirect(applicationConfig.graphScopes);
        });

    }
//===========================================================================Authentication code ends here ========================================================================
    function updateUI() {
        var authButton = document.getElementById('auth');
        authButton.innerHTML = 'logout';
        authButton.setAttribute('onclick', 'logout();');
        var label = document.getElementById('label');
        label.innerText = "Welcome to Microsoft Authentication library!!";

        var callGraphButton = document.getElementById('callGraph');
        callGraphButton.innerHTML = 'Call MS Graph';
        callGraphButton.setAttribute('onclick', 'callGraph();');
        callGraphButton.style.visibility = "visible";

    }

    //callback function for XMLHttpRequest
    function httpGetCallback(responseText) {
        var res = JSON.parse(responseText);
        var label = document.getElementById('label');
        label.innerText = "Welcome " + res.displayName + " to Microsoft Graph API!!";
    }


    //function to make http get request using XMLHttpRequest
    function httpGetAsync(theUrl, accessToken, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                callback(xmlHttp.responseText);
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xmlHttp.send(null);
    }

</script>
</body>
</html>
